"use strict";const _csrf=document.querySelector(".csrf-token").value,consolidaPlanid={semestre:""},selecaoSemestre=`\n  <h1>Gestão de planids (Centro)</h1>\n  <form class='form-selecao-semestre formulario'>\n    <div>\n      <label for='input-selecionar-ano'>Ano:</label>\n      <input type='number' min='2019' max='${(new Date).getMonth(),(new Date).getFullYear()}' id='input-selecionar-ano' value='${(new Date).getMonth(),(new Date).getFullYear()}'>\n    </div>\n      <div>\n      <label for='input-selecionar-semestre'>Semestre:</label>\n      <input type='number' min='1' max='2' id='input-selecionar-semestre' value='${(new Date).getMonth()<7?1:2}'>\n    </div>\n    <div>\n      <input type='submit' value='selecionar semestre'>\n    </div>\n  </form>\n`,tratarDadosConsolidacaoPlanid=e=>{let a=0,n=0;const o={};for(let i=0;i<e.length;i++){const s=e[i].unidadePreenchimentoPlanid||"unidadeLocalizacao";if(o[e[i][s]]?o[e[i][s]].docentesCadastrados+=1:o[e[i][s]]={docentesCadastrados:1,naoIniciouPreenchimento:0,enviouPlanid:0,preenchimentoIniciado:0},e[i].planids.length){const t=e[i].planids.find(e=>e.semestre===consolidaPlanid.semestre);t&&t.enviado?(o[e[i][s]].enviouPlanid+=1,a++):t&&!t.enviado?(o[e[i][s]].preenchimentoIniciado+=1,n++):t||(o[e[i][s]].naoIniciouPreenchimento+=1)}else o[e[i][s]].naoIniciouPreenchimento+=1}return{unidades:o,totalDocentesCadastrados:e.length,totalEnvios:a,totalEmPreenchimento:n}},estatisticasResumoCentroCSV=async()=>{operacaoDB("Recuperando informações no banco de dados");let e="data:text/csv;charset=utf-8,\ufeff";const a={exibir:JSON.stringify("nome unidadePreenchimentoPlanid unidadeLotacao unidadeLocalizacao planids categoria"),query:JSON.stringify([{categoria:"docente"}]),populate:JSON.stringify({path:"planids",options:{select:"enviado semestre"}})},n=await variaveisGlobais.ajax("/users/recuperarContatos","GET",{_csrf:_csrf,...a},()=>variaveisGlobais.controlarVisibilidade("ocultar","#mensagens-genericas")),o=tratarDadosConsolidacaoPlanid(n),{separador:i}=statState;let s=`'total'${i} ${o.totalDocentesCadastrados}${i} ${o.totalEnvios}${i} ${o.totalEmPreenchimento}${i} ${o.totalDocentesCadastrados-(o.totalEnvios+o.totalEmPreenchimento)}${i} ${(100*o.totalEnvios/o.totalDocentesCadastrados).toFixed(0)}%\r\n`;const t=Object.entries(o.unidades);for(let e=0;e<t.length;e++)s+=`${t[e][0]}${i} ${t[e][1].docentesCadastrados}${i} ${t[e][1].enviouPlanid}${i} ${t[e][1].preenchimentoIniciado}${i} ${t[e][1].naoIniciouPreenchimento}${i} ${(100*t[e][1].enviouPlanid/t[e][1].docentesCadastrados).toFixed(0)}%\r`;e+=`${["unidade","docentes cadastrados","total de envios","nao enviaram","nao preencheram","Percentual de envio"].join(i)}\r\n`,e+=s,prepararLink(e,consolidaPlanid.semestre,"carga_horaria_resumo_ccs")},selecionarArquivoCSVHandler=(e,a)=>{if(definirSeparadorDecimal(e.target.value),variaveisGlobais.controlarVisibilidade("ocultar","#mensagens-genericas"),a.target.dataset.csv){switch(a.target.dataset.csv){case"resumo-centro":estatisticasResumoCentroCSV()}}},selecionarIdioma=e=>{variaveisGlobais.exibirMensagem("\n    <form class='form-selecao-idioma-so formulario'>\n      <div>\n        <label>Qual o idioma de seu visualizador de planilha?</label>\n        <select>\n          <option value='' selected readOnly>Selecione:</option>\n          <option value='pt'>Português</option>\n          <option value='en'>Inglês</option>\n        </select>\n      </div>\n      <div></div>\n    </form>    \n  "),document.querySelector(".form-selecao-idioma-so").addEventListener("change",a=>selecionarArquivoCSVHandler(a,e))},csvDOM=()=>{let e=`\n    <div class='csv-estatisticas-planid__div'>\n      <h2>${consolidaPlanid.semestre}</h2>\n      <h2>Arquivos em formato .csv para download</h2>\n      <div class='csv-estatisticas-planid__link' data-csv='resumo-centro'>\n        <a class='link-estatisticas-resumo-centro' >\n          <i class='fa fa-bar-chart-o'></i>\n          <span class='btn-csv'>Resumo do Centro</span>\n        </a>\n      </div>\n    </div>`;document.querySelector(".planids-consolidacao__pesquisas").innerHTML=e,document.querySelector(".csv-estatisticas-planid__div").addEventListener("click",selecionarIdioma)},selecionarSemestreHandler=async e=>{e.preventDefault(),operacaoDB();const a=`${e.target.elements["input-selecionar-ano"].value}-${e.target.elements["input-selecionar-semestre"].value}`,n={query:JSON.stringify({semestre:a}),countOnly:!0};(await variaveisGlobais.ajax("/planids/recuperar-planid-homologacao","GET",{_csrf:_csrf,...n},()=>variaveisGlobais.controlarVisibilidade("ocultar","#mensagens-genericas"))).length?(consolidaPlanid.semestre=a,csvDOM()):variaveisGlobais.exibirMensagem(`<h3>Não há planids registrados no semestre ${a}</h3>`)},iniciarModulo=()=>{document.querySelector(".planids-consolidacao__selecao-semestre").innerHTML=selecaoSemestre,document.querySelector(".form-selecao-semestre").addEventListener("submit",selecionarSemestreHandler)};document.addEventListener("DOMContentLoaded",iniciarModulo);